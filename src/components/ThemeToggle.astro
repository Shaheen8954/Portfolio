---
import { Moon, Sun } from 'lucide-react';
import { Button } from '@/components/ui/button';
---

<Button
  variant="ghost"
  size="icon"
  className="transition-all"
  data-theme-toggle
  aria-pressed="false"
  type="button"
>
  <Sun className="h-[1.5rem] w-[1.3rem] dark:hidden" aria-hidden="true" />
  <Moon className="hidden h-5 w-5 dark:block" aria-hidden="true" />
  <span class="sr-only">Toggle theme</span>
</Button>

<script>
  // Update aria-pressed and attach direct click handlers as fallback
  if (typeof window !== 'undefined') {
    const updateAriaPressed = () => {
      const isDark = document.documentElement.classList.contains('dark');
      const buttons = document.querySelectorAll('[data-theme-toggle]');
      buttons.forEach((btn) => {
        btn.setAttribute('aria-pressed', String(isDark));
      });
    };
    
    const attachClickHandlers = () => {
      const buttons = document.querySelectorAll('[data-theme-toggle]');
      buttons.forEach((btn) => {
        // Check if handler already attached
        if (btn.hasAttribute('data-theme-handler-attached')) return;
        btn.setAttribute('data-theme-handler-attached', 'true');
        
        // Attach direct click handler as fallback
        btn.addEventListener('click', (e) => {
          // Only handle if event hasn't been handled by theme manager
          if (!e.defaultPrevented) {
            e.preventDefault();
            e.stopPropagation();
            // Dispatch to theme manager via custom event
            window.dispatchEvent(new CustomEvent('theme-toggle-click'));
          }
        }, { once: false, capture: false });
      });
    };
    
    const init = () => {
      updateAriaPressed();
      attachClickHandlers();
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    // Listen for theme changes
    window.addEventListener('themechange', updateAriaPressed);
    
    // Update after Astro page swaps
    document.addEventListener('astro:after-swap', () => {
      updateAriaPressed();
      attachClickHandlers();
    });
  }
</script>
